## 第13章--数据库恢复技术

### 恢复

数据库的恢复基于事务的原子性特征

数据库恢复机制恢复有两个关键问题：

1. **如何建立备份数据**
2. **如何利用备份数据恢复**

数据转储是数据库恢复中采用的基本技术，分为：

- 静态转储：是在系统中无运行事务时进行转储操作，必须等到正在运行的所有事务结束才能开始，且转储时也不允许有新的事务运行
- 动态转储：不用等待正在运行的事务结束就可以进行，且在转储过程中也允许运行新的事务。因此转储过程中不会降低数据库的可用性，但不能保证转储结束后的数据库样本是正确的

### 数据库故障的种类

1. 事务内部的故障

   解决：数据库的恢复机制要在不影响其他事务运行的情况下，强行撤销该事务中的全部操作，使得该事务就像没发生过的一样。这类操作称为**事务撤销（UNDO）**

2. 系统故障

   1. 一些未完成的事务的结果可能已经送到物理数据库中，从而造成数据库可能处于不正确状态
   2. 有些已经提交的事务可能有一部分结果还保存在缓冲区，尚未写到物理数据库中，这样的系统故障会丢失这些事务对数据的修改，也使得数据库处于不一致的状态

   解决方法：恢复子系统必须在系统重新启动时撤销所有为完成的事务，并重做所有已提交的事务，以保证数据库恢复到一致状态

3. 其他故障

### 数据库恢复类型

#### 向前恢复(或重做REDO)

``` mermaid
graph LR;
	A[(最后一次数据库备份)]-->B[前滚程序]-->C[(重建后的数据库)]
	D[(事务日志)]-->B
```

#### 向后恢复（撤销UNDO）

``` mermaid
graph LR;
	A[(当前数据库)]-->B[回滚程序]-->C[(改正后的数据库)]
	D[(事务日志)]-->B
```

#### 介质故障恢复

很难

### 恢复技术

1. 物理损坏
2. 非物理损坏或事务故障
   - 延迟更新
   - 立即更新

#### 延迟更新技术

采用延迟更新技术时，只有达到事务的提交点，更新才被写入数据库。在事务执行阶段，更新只被记录在事务日记和缓冲区中。

事务日志的内容如下：

- 当事务T启动时，将"事务开始"（或<T,BEGIN>）记录写入事务日志中
- 当事务T执行期间，写入一条新的日志记录，该新纪录包含所有之前指定的日志数据
- 当事务T的所有活动成功提交时，将记录<T,COMMIT>写入事务日志，并将该事务的所有日志写入磁盘上，然后提交该事务，使用日志记录来完成对数据库的真正更新
- 如果事务T被撤销了，则忽略该事务的事务日志，并且不会执行写操作

#### 立即更新技术

采用立即更新技术，更新一旦发生即被施加到数据库中，而无需等待事务提交点以及所有的更改被保存在事务日志时

这种情况下使用日志文件从以下几个方面来防止系统故障：

- 